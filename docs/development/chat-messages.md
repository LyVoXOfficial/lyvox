# –ß–∞—Ç / –°–æ–æ–±—â–µ–Ω–∏—è

## Architecture

–°–º. —Ç–∞–∫–∂–µ: `../domains/chat.md`

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:**
- Realtime: Supabase Realtime (websocket)
- SSR: –Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
- Client subscription: live updates

## Database Schema

```sql
CREATE TABLE public.conversations (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  created_by uuid NOT NULL REFERENCES auth.users(id),
  advert_id uuid REFERENCES public.adverts(id),
  last_message_at timestamptz,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

CREATE TABLE public.conversation_participants (
  conversation_id uuid REFERENCES public.conversations(id) ON DELETE CASCADE,
  user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE,
  role text CHECK (role IN ('owner', 'peer')),
  muted boolean DEFAULT false,
  last_read_at timestamptz,
  PRIMARY KEY (conversation_id, user_id)
);

CREATE TABLE public.messages (
  id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  conversation_id uuid NOT NULL REFERENCES public.conversations(id) ON DELETE CASCADE,
  author_id uuid NOT NULL REFERENCES auth.users(id),
  body text NOT NULL,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

CREATE INDEX idx_messages_conversation_created 
  ON public.messages(conversation_id, created_at DESC);
CREATE INDEX idx_messages_author 
  ON public.messages(author_id, created_at DESC);
CREATE INDEX idx_conversations_last_message 
  ON public.conversations(last_message_at DESC);
```

## RLS Policies

**conversations:**
```sql
-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ –º–æ–≥—É—Ç —á–∏—Ç–∞—Ç—å —Å–≤–æ–∏ –¥–∏–∞–ª–æ–≥–∏
CREATE POLICY "participants_can_read" 
  ON public.conversations FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM public.conversation_participants
      WHERE conversation_id = conversations.id
        AND user_id = auth.uid()
    )
  );

-- –ê–¥–º–∏–Ω—ã –º–æ–≥—É—Ç —á–∏—Ç–∞—Ç—å –≤—Å–µ
CREATE POLICY "admins_can_read_all"
  ON public.conversations FOR SELECT
  USING (public.is_admin());
```

**messages:**
```sql
-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ –¥–∏–∞–ª–æ–≥–∞ –º–æ–≥—É—Ç —á–∏—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
CREATE POLICY "participants_can_read_messages"
  ON public.messages FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM public.conversation_participants
      WHERE conversation_id = messages.conversation_id
        AND user_id = auth.uid()
    )
  );

-- –¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å
CREATE POLICY "author_can_insert"
  ON public.messages FOR INSERT
  WITH CHECK (author_id = auth.uid());
```

## API Endpoints

| Endpoint | –ú–µ—Ç–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ | Auth |
|----------|-------|----------|------|
| `/api/chat/start` | POST | –°–æ–∑–¥–∞—Ç—å/–Ω–∞–π—Ç–∏ –¥–∏–∞–ª–æ–≥ | Required |
| `/api/chat/send` | POST | –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ | Required |
| `/api/chat/history` | GET | –ò—Å—Ç–æ—Ä–∏—è —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π | Required |
| `/api/chat/read` | POST | –û—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º | Required |

**POST /api/chat/start:**
```typescript
Body: {
  advert_id?: uuid,
  peer_id: uuid
}

// –õ–æ–≥–∏–∫–∞:
// 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ peer_id != auth.uid()
// 2. –ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞ –ø–æ advert_id + participants
// 3. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω - —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ
// 4. –í–æ–∑–≤—Ä–∞—Ç conversation_id
```

**POST /api/chat/send:**
```typescript
Body: {
  conversation_id: uuid,
  body: string
}

// –õ–æ–≥–∏–∫–∞:
// 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—á–∞—Å—Ç–∏—è –≤ –¥–∏–∞–ª–æ–≥–µ
// 2. –í—Å—Ç–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
// 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ last_message_at –≤ conversations
// 4. Rate limiting: 20 —Å–æ–æ–±—â–µ–Ω–∏–π/–º–∏–Ω
```

**GET /api/chat/history:**
```typescript
Query: {
  conversationId: uuid,
  cursor?: bigint, // id –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
  limit?: number // default 50
}

// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ cursor (–±–æ–ª–µ–µ —Å—Ç–∞—Ä—ã–µ)
```

## Frontend Components

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ü—É—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|------|----------|
| ChatListPage | `apps/web/src/app/(protected)/chat/page.tsx` | –°–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤ (SSR) |
| ChatWindowPage | `apps/web/src/app/(protected)/chat/[conversationId]/page.tsx` | –û–∫–Ω–æ —á–∞—Ç–∞ (SSR + client) |
| ChatWindow | `apps/web/src/components/ChatWindow.tsx` | –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å Realtime |
| MessageList | `apps/web/src/components/MessageList.tsx` | –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π |
| MessageInput | `apps/web/src/components/MessageInput.tsx` | –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è |

## Realtime Subscription

**Hook: `useRealtimeMessages`**
```typescript
function useRealtimeMessages(conversationId: string) {
  const [messages, setMessages] = useState<Message[]>([]);
  const supabase = supabaseBrowser();

  useEffect(() => {
    const channel = supabase
      .channel(`conversation:${conversationId}`)
      .on('postgres_changes', {
        event: 'INSERT',
        schema: 'public',
        table: 'messages',
        filter: `conversation_id=eq.${conversationId}`
      }, (payload) => {
        setMessages(prev => [...prev, payload.new as Message]);
      })
      .on('system', {}, (payload) => {
        // Handle errors, reconnect logic
      })
      .subscribe();

    return () => {
      channel.unsubscribe();
    };
  }, [conversationId]);

  return messages;
}
```

**Reconnect logic:**
- –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–ø–æ–¥–ø–∏—Å–∫–∞
- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä "Reconnecting..."

## UI Features

### –°–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤

**–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ:**
- –ê–≤–∞—Ç–∞—Ä —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
- –ò–º—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
- –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (preview)
- –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö (badge)

**–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:**
- –ü–æ `last_message_at` DESC (—Å–∞–º—ã–µ —Å–≤–µ–∂–∏–µ —Å–≤–µ—Ä—Ö—É)

### –û–∫–Ω–æ —á–∞—Ç–∞

**–§—É–Ω–∫—Ü–∏–∏:**
- –í–∏—Ä—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π (react-window)
- –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ (–ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Ä–∞–∑—É, –ø–æ—Ç–æ–º –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å)
- Retry –ø—Ä–∏ –æ—à–∏–±–∫–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç..." (future, —á–µ—Ä–µ–∑ presence)
- Timestamps (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ: "2 –º–∏–Ω –Ω–∞–∑–∞–¥")
- Read receipts (future)

## Rate Limiting

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- 20 —Å–æ–æ–±—â–µ–Ω–∏–π / –º–∏–Ω—É—Ç—É –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ `/api/chat/send`

**Response –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏:**
```json
{
  "ok": false,
  "error": "rate_limited",
  "retry_after_seconds": 15
}
```

## –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–¢—Ä–∏–≥–≥–µ—Ä—ã:**
- –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–µ—Å–ª–∏ —É—á–∞—Å—Ç–Ω–∏–∫ offline)
- Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–µ—Å–ª–∏ preferences —Ä–∞–∑—Ä–µ—à–∞—é—Ç)
- Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (future)

**–î–µ–¥u–ø–ª–∏–∫–∞—Ü–∏—è:**
- –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –µ—Å–ª–∏ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 60 —Å–µ–∫—É–Ω–¥

## –ú–æ–¥–µ—Ä–∞—Ü–∏—è

**–°–≤—è–∑—å —Å reports:**
- –ö–Ω–æ–ø–∫–∞ "–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è" –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–∏
- –°–æ–∑–¥–∞–Ω–∏–µ `reports` —Å `target_type = 'message'`, `target_id = messages.id`
- Auto-mute –ø—Ä–∏ X –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã—Ö –∂–∞–ª–æ–±

## –ß–µ–∫-–ª–∏—Å—Ç MVP

- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü —á–∞—Ç–∞
- [ ] RLS policies
- [ ] API endpoints (start, send, history, read)
- [ ] Realtime subscription —Å reconnect –ª–æ–≥–∏–∫–æ–π
- [ ] UI: —Å–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤, –æ–∫–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π
- [ ] Rate limiting: 20 —Å–æ–æ–±—â–µ–Ω–∏–π/–º–∏–Ω –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: email –ø—Ä–∏ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ (–µ—Å–ª–∏ —É—á–∞—Å—Ç–Ω–∏–∫ offline)
- [ ] –ú–æ–¥–µ—Ä–∞—Ü–∏—è: –∫–Ω–æ–ø–∫–∞ "–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è" –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–∏

## TODO for developers

1. **–°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è —á–∞—Ç–∞**
   - [ ] –¢–∞–±–ª–∏—Ü—ã: conversations, conversation_participants, messages
   - [ ] –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
   - [ ] –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è `updated_at` –∏ `last_message_at`

2. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å RLS policies**
   - [ ] conversations: participants –∏–ª–∏ admins
   - [ ] messages: participants —á–∏—Ç–∞—é—Ç, –∞–≤—Ç–æ—Ä –ø–∏—à–µ—Ç
   - [ ] conversation_participants: —Ç–æ–ª—å–∫–æ —É—á–∞—Å—Ç–Ω–∏–∫–∏

3. **–°–æ–∑–¥–∞—Ç—å API endpoints**
   - [ ] POST `/api/chat/start` - —Å–æ–∑–¥–∞–Ω–∏–µ/–ø–æ–∏—Å–∫ –¥–∏–∞–ª–æ–≥–∞
   - [ ] POST `/api/chat/send` - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
   - [ ] GET `/api/chat/history` - –∏—Å—Ç–æ—Ä–∏—è —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
   - [ ] POST `/api/chat/read` - –æ—Ç–º–µ—Ç–∫–∞ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º
   - [ ] Rate limiting –Ω–∞ send endpoint

4. **–°–æ–∑–¥–∞—Ç—å —Ö—É–∫ useRealtimeMessages**
   - [ ] –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª `conversation:${id}`
   - [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ INSERT —Å–æ–±—ã—Ç–∏–π
   - [ ] Reconnect –ª–æ–≥–∏–∫–∞
   - [ ] Cleanup –ø—Ä–∏ unmount

5. **–°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç ChatListPage**
   - [ ] SSR –¥–ª—è –Ω–∞—á–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤
   - [ ] –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
   - [ ] –ù–∞–≤–∏–≥–∞—Ü–∏—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–∏–∞–ª–æ–≥
   - [ ] –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö

6. **–°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç ChatWindow**
   - [ ] SSR –¥–ª—è –Ω–∞—á–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏
   - [ ] Realtime subscription –¥–ª—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
   - [ ] –í–∏—Ä—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ (react-window)
   - [ ] –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
   - [ ] Retry –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

7. **–°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç MessageInput**
   - [ ] Textarea —Å –∞–≤—Ç–æ-—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º
   - [ ] –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
   - [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è (–Ω–µ –ø—É—Å—Ç–æ–µ, max –¥–ª–∏–Ω–∞)
   - [ ] Keyboard shortcuts (Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏, Shift+Enter –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)

8. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π**
   - [ ] Email –ø—Ä–∏ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ (–µ—Å–ª–∏ offline)
   - [ ] In-app —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (future)
   - [ ] Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (future)

9. **–î–æ–±–∞–≤–∏—Ç—å –º–æ–¥–µ—Ä–∞—Ü–∏—é**
   - [ ] –ö–Ω–æ–ø–∫–∞ "–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è" –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–∏
   - [ ] –°–≤—è–∑—å —Å `reports` —Ç–∞–±–ª–∏—Ü–µ–π
   - [ ] Auto-mute –ª–æ–≥–∏–∫–∞ (future)

---

## üîó Related Docs

**Domains:** [chat.md](../domains/chat.md) ‚Ä¢ [deals.md](../domains/deals.md)
**Development:** [MASTER_CHECKLIST.md](./MASTER_CHECKLIST.md) ‚Ä¢ [database-schema.md](./database-schema.md) ‚Ä¢ [security-compliance.md](./security-compliance.md)




