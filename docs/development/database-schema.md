# Supabase ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ñ‚Ð°Ð±Ð»Ð¸Ñ†

## Core Tables (Current)

| Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° | ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ | RLS | Ð˜Ð½Ð´ÐµÐºÑÑ‹ |
|---------|-----------|-----|---------|
| `adverts` | ÐžÐ±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ñ | âœ… | `user_id`, `category_id`, `status`, `created_at` |
| `media` | Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ð¹ | âœ… | `advert_id`, `sort` |
| `categories` | ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ (3 ÑƒÑ€Ð¾Ð²Ð½Ñ) | âœ… | `parent_id`, `path`, `is_active` |
| `profiles` | ÐŸÑ€Ð¾Ñ„Ð¸Ð»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ | âœ… | `id` (PK) |
| `phones` | Ð’ÐµÑ€Ð¸Ñ„Ð¸Ñ†Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ñ‹ | âœ… | `user_id`, `e164` |
| `phone_otps` | OTP ÐºÐ¾Ð´Ñ‹ | âœ… | `user_id`, `e164`, `expires_at` |
| `reports` | Ð–Ð°Ð»Ð¾Ð±Ñ‹ Ð½Ð° Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ñ | âœ… | `advert_id`, `reporter`, `status` |
| `trust_score` | Trust score Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ | âœ… | `user_id` |
| `logs` | Audit Ð»Ð¾Ð³Ð¸ | âœ… | `user_id`, `action`, `created_at` |

## Vehicle Catalog Tables

| Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° | ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ | Rows |
|---------|-----------|------|
| `vehicle_makes` | ÐœÐ°Ñ€ÐºÐ¸ Ð°Ð²Ñ‚Ð¾ | 188 |
| `vehicle_models` | ÐœÐ¾Ð´ÐµÐ»Ð¸ Ð°Ð²Ñ‚Ð¾ | 558 |
| `vehicle_generations` | ÐŸÐ¾ÐºÐ¾Ð»ÐµÐ½Ð¸Ñ Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹ | 724 |
| `vehicle_make_i18n` | ÐŸÐµÑ€ÐµÐ²Ð¾Ð´Ñ‹ Ð¼Ð°Ñ€Ð¾Ðº | 940 |
| `vehicle_model_i18n` | ÐŸÐµÑ€ÐµÐ²Ð¾Ð´Ñ‹ Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹ | 2790 |
| `vehicle_generation_i18n` | ÐŸÐµÑ€ÐµÐ²Ð¾Ð´Ñ‹ Ð¿Ð¾ÐºÐ¾Ð»ÐµÐ½Ð¸Ð¹ | 3620 |
| `vehicle_insights` | Insights Ð¿Ð¾ Ð¼Ð¾Ð´ÐµÐ»ÑÐ¼ | 558 |

## New Tables for Full Platform

### Chat Tables

```sql
CREATE TABLE public.conversations (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  created_by uuid NOT NULL REFERENCES auth.users(id),
  advert_id uuid REFERENCES public.adverts(id),
  last_message_at timestamptz,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

CREATE TABLE public.conversation_participants (
  conversation_id uuid REFERENCES public.conversations(id) ON DELETE CASCADE,
  user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE,
  role text CHECK (role IN ('owner', 'peer')),
  muted boolean DEFAULT false,
  last_read_at timestamptz,
  PRIMARY KEY (conversation_id, user_id)
);

CREATE TABLE public.messages (
  id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  conversation_id uuid NOT NULL REFERENCES public.conversations(id) ON DELETE CASCADE,
  author_id uuid NOT NULL REFERENCES auth.users(id),
  body text NOT NULL,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

### Billing Tables

```sql
CREATE TABLE public.products (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  code text UNIQUE NOT NULL,
  name jsonb NOT NULL,
  price_cents integer NOT NULL,
  currency text DEFAULT 'EUR',
  active boolean DEFAULT true,
  created_at timestamptz DEFAULT now()
);

CREATE TABLE public.purchases (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL REFERENCES auth.users(id),
  product_code text NOT NULL REFERENCES public.products(code),
  provider text NOT NULL,
  provider_session_id text UNIQUE,
  provider_payment_intent_id text,
  status text NOT NULL,
  amount_cents integer NOT NULL,
  currency text DEFAULT 'EUR',
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

CREATE TABLE public.benefits (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  purchase_id uuid REFERENCES public.purchases(id),
  user_id uuid NOT NULL REFERENCES auth.users(id),
  advert_id uuid REFERENCES public.adverts(id),
  benefit_type text NOT NULL,
  valid_from timestamptz DEFAULT now(),
  valid_until timestamptz NOT NULL,
  created_at timestamptz DEFAULT now()
);
```

### Notifications Table

```sql
CREATE TABLE public.notifications (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  type text NOT NULL,
  channel text NOT NULL,
  title text NOT NULL,
  body text NOT NULL,
  payload jsonb,
  read_at timestamptz,
  sent_at timestamptz,
  created_at timestamptz DEFAULT now()
);
```

### Other Tables

```sql
-- Ð˜Ð·Ð±Ñ€Ð°Ð½Ð½Ð¾Ðµ
CREATE TABLE public.favorites (
  user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE,
  advert_id uuid REFERENCES public.adverts(id) ON DELETE CASCADE,
  created_at timestamptz DEFAULT now(),
  PRIMARY KEY (user_id, advert_id)
);

-- Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¿Ð¾Ð¸ÑÐºÐ°
CREATE TABLE public.search_history (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES auth.users(id),
  query text,
  filters jsonb,
  created_at timestamptz DEFAULT now()
);

-- Ð›Ð¾Ð³Ð¸ Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ð¸
CREATE TABLE public.moderation_logs (
  id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  advert_id uuid NOT NULL REFERENCES public.adverts(id),
  moderator_id uuid REFERENCES auth.users(id),
  action text NOT NULL,
  reason text,
  ai_score integer,
  created_at timestamptz DEFAULT now()
);

-- Fraud rules
CREATE TABLE public.fraud_rules (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  rule_name text UNIQUE NOT NULL,
  condition_sql text NOT NULL,
  action text NOT NULL,
  severity integer CHECK (severity >= 1 AND severity <= 10),
  active boolean DEFAULT true,
  created_at timestamptz DEFAULT now()
);
```

## Indexes Strategy

### Performance Indexes

| Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° | Ð˜Ð½Ð´ÐµÐºÑÑ‹ | ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ |
|---------|---------|-----------|
| `adverts` | `(status, created_at DESC)` | Ð¡Ð²ÐµÐ¶Ð¸Ðµ Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ñ |
| `adverts` | `(category_id, status, created_at DESC)` | ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ |
| `adverts` | `(user_id, status)` | ÐžÐ±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ |
| `messages` | `(conversation_id, created_at DESC)` | Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ñ‡Ð°Ñ‚Ð° |
| `notifications` | `(user_id, read_at) WHERE read_at IS NULL` | ÐÐµÐ¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ‹Ðµ |
| `benefits` | `(advert_id) WHERE advert_id IS NOT NULL` | ÐÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð±ÑƒÑÑ‚Ñ‹ |

### Full-Text Search Indexes

```sql
-- GIN Ð¸Ð½Ð´ÐµÐºÑ Ð´Ð»Ñ full-text search
CREATE INDEX idx_adverts_title_description_fts 
  ON public.adverts 
  USING gin(to_tsvector('english', coalesce(title, '') || ' ' || coalesce(description, '')));
```

## Triggers

**Updated_at trigger:**
```sql
CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ðº Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð°Ð¼
CREATE TRIGGER update_adverts_updated_at
  BEFORE UPDATE ON public.adverts
  FOR EACH ROW EXECUTE FUNCTION set_updated_at();
```

## Foreign Keys

Ð’ÑÐµ foreign keys Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð¸Ð¼ÐµÑ‚ÑŒ:
- `ON DELETE CASCADE` Ð´Ð»Ñ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
- `ON DELETE RESTRICT` Ð´Ð»Ñ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ñ… ÑÐ²ÑÐ·ÐµÐ¹
- Ð˜Ð½Ð´ÐµÐºÑÑ‹ Ð½Ð° foreign key ÐºÐ¾Ð»Ð¾Ð½ÐºÐ°Ñ…

## Ð§ÐµÐº-Ð»Ð¸ÑÑ‚ MVP

- [ ] Ð’ÑÐµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹ Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ constraints
- [ ] Ð˜Ð½Ð´ÐµÐºÑÑ‹ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹
- [ ] RLS policies Ð½Ð° Ð²ÑÐµÑ… Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð°Ñ…
- [ ] Triggers Ð´Ð»Ñ `updated_at`
- [ ] ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð²ÐµÑ€ÑÐ¸Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹

## TODO for developers

1. **Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð´Ð»Ñ Ð½Ð¾Ð²Ñ‹Ñ… Ñ‚Ð°Ð±Ð»Ð¸Ñ†**
   - [ ] Chat: conversations, participants, messages
   - [ ] Billing: products, purchases, benefits
   - [ ] Notifications: notifications
   - [ ] Ð”Ñ€ÑƒÐ³Ð¸Ðµ: favorites, search_history, moderation_logs, fraud_rules

2. **ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸Ð½Ð´ÐµÐºÑÑ‹**
   - [ ] ÐÐ½Ð°Ð»Ð¸Ð· query patterns
   - [ ] Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐ¾ÑÑ‚Ð°Ð²Ð½Ñ‹Ñ… Ð¸Ð½Ð´ÐµÐºÑÐ¾Ð²
   - [ ] Full-text search Ð¸Ð½Ð´ÐµÐºÑÑ‹ (GIN)

3. **Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ triggers**
   - [ ] `set_updated_at()` Ð´Ð»Ñ Ð²ÑÐµÑ… Ñ‚Ð°Ð±Ð»Ð¸Ñ† Ñ `updated_at`
   - [ ] ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ `last_message_at` Ð² conversations Ð¿Ñ€Ð¸ Ð½Ð¾Ð²Ð¾Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸
   - [ ] ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ `advert_count` Ð² categories (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾, Ñ‡ÐµÑ€ÐµÐ· materialized view)

4. **ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ foreign keys**
   - [ ] ÐŸÑ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ðµ ON DELETE Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸
   - [ ] Ð˜Ð½Ð´ÐµÐºÑÑ‹ Ð½Ð° Ð²ÑÐµÑ… FK ÐºÐ¾Ð»Ð¾Ð½ÐºÐ°Ñ…
   - [ ] ÐšÐ°ÑÐºÐ°Ð´Ð½Ð¾Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð³Ð´Ðµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾

5. **ÐŸÑ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ**
   - [ ] EXPLAIN ANALYZE Ð´Ð»Ñ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
   - [ ] ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¼ÐµÐ´Ð»ÐµÐ½Ð½Ñ‹Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
   - [ ] ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ñ€Ð°Ð·Ð¼ÐµÑ€Ð¾Ð² Ñ‚Ð°Ð±Ð»Ð¸Ñ†

---

## ðŸ”— Related Docs

**Domains:** [chat.md](../domains/chat.md)
**Development:** [MASTER_CHECKLIST.md](./MASTER_CHECKLIST.md) â€¢ [deep-audit-20251108.md](./deep-audit-20251108.md) â€¢ [user-profile.md](./user-profile.md)
**Catalog:** [CATALOG_MASTER.md](../catalog/CATALOG_MASTER.md)




