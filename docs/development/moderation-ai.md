# –ú–æ–¥–µ—Ä–∞—Ü–∏—è (AI + —á–µ–ª–æ–≤–µ–∫)

## Current State

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å |
|-----------|--------|
| –ë–∞–∑–æ–≤–∞—è –º–æ–¥–µ—Ä–∞—Ü–∏—è | `reports` —Ç–∞–±–ª–∏—Ü–∞ |
| –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å | `/admin/reports` |

## MVP Enhancements

### AI Moderation Flow

| –®–∞–≥ | –î–µ–π—Å—Ç–≤–∏–µ | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|-----|----------|-----------|
| 1 | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—É–±–ª–∏–∫—É–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–µ | `status='draft'` ‚Üí `'pending_review'` (–µ—Å–ª–∏ –ø—Ä–µ–º–æ–¥–µ—Ä–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞) |
| 2 | AI –∞–Ω–∞–ª–∏–∑ –æ–±—ä—è–≤–ª–µ–Ω–∏—è | –û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞: 0-100 |
| 3 | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ | score < 30: auto-approve<br>score 30-70: manual review<br>score > 70: auto-reject |
| 4 | –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é | –û–¥–æ–±—Ä–µ–Ω–æ / –û—Ç–∫–ª–æ–Ω–µ–Ω–æ / –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ |

### AI Scoring Criteria

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –í–µ—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-----|----------|
| –¢–µ–∫—Å—Ç (spam/fraud keywords) | 40% | –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞, –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—Ä–∞–∑—ã |
| –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (NSFW/–∫–∞—á–µ—Å—Ç–≤–æ) | 30% | –ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ –Ω–∞ NSFW –∫–æ–Ω—Ç–µ–Ω—Ç, –∫–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π |
| –¶–µ–Ω–∞ (–∞–Ω–æ–º–∞–ª—å–Ω–æ—Å—Ç—å) | 15% | –°–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∞—è —Ü–µ–Ω–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ |
| –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–≤—Ü–∞ | 15% | Trust score, –∏—Å—Ç–æ—Ä–∏—è –Ω–∞—Ä—É—à–µ–Ω–∏–π |

### Database Changes

```sql
ALTER TABLE public.adverts ADD COLUMN ai_moderation_score integer;
ALTER TABLE public.adverts ADD COLUMN ai_moderation_reason text;
ALTER TABLE public.adverts ADD COLUMN moderation_status text DEFAULT 'pending'; 
-- 'pending', 'approved', 'rejected', 'auto_approved', 'auto_rejected'

CREATE TABLE public.moderation_logs (
  id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  advert_id uuid NOT NULL REFERENCES public.adverts(id),
  moderator_id uuid REFERENCES auth.users(id), -- NULL if AI
  action text NOT NULL, -- 'approve', 'reject', 'auto_approve', 'auto_reject'
  reason text,
  ai_score integer,
  created_at timestamptz DEFAULT now()
);

CREATE INDEX idx_moderation_logs_advert 
  ON public.moderation_logs(advert_id, created_at DESC);
```

## API Endpoints

| Endpoint | –ú–µ—Ç–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ | Auth |
|----------|-------|----------|------|
| `/api/moderation/analyze` | POST | AI –∞–Ω–∞–ª–∏–∑ –æ–±—ä—è–≤–ª–µ–Ω–∏—è | Required |
| `/api/moderation/review` | POST | –†–µ—à–µ–Ω–∏–µ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞ | Admin |
| `/api/moderation/queue` | GET | –û—á–µ—Ä–µ–¥—å –º–æ–¥–µ—Ä–∞—Ü–∏–∏ | Admin |

**POST /api/moderation/analyze:**
```typescript
Body: {
  advertId: uuid
}

Response: {
  ok: true,
  score: 45,
  reason: "Price seems unusually low for this category",
  autoAction: 'manual' // 'approve' | 'reject' | 'manual'
}
```

**POST /api/moderation/review:**
```typescript
Body: {
  advertId: uuid,
  action: 'approve' | 'reject',
  reason?: string
}

// –õ–æ–≥–∏–∫–∞:
// 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ moderation_status
// 2. –ï—Å–ª–∏ approve ‚Üí status='active'
// 3. –ï—Å–ª–∏ reject ‚Üí status='blocked'
// 4. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ moderation_logs
// 5. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
```

## AI Implementation

### Edge Function

**–ü—É—Ç—å:** `supabase/functions/ai-moderation/index.ts`

**Input:**
```typescript
{
  title: string,
  description: string,
  price: number,
  category: string,
  images: string[], // URLs
  seller_trust_score: number
}
```

**LLM Prompt:**
```
Analyze this marketplace listing for spam, fraud, or policy violations.

Title: {title}
Description: {description}
Price: {price} EUR
Category: {category}

Score criteria:
- Text analysis (spam/fraud keywords): 0-40 points
- Image analysis (NSFW/quality): 0-30 points
- Price analysis (suspiciously low): 0-15 points
- Seller behavior (trust score, history): 0-15 points

Return JSON:
{
  "score": 0-100,
  "reason": "explanation",
  "autoAction": "approve" | "reject" | "manual"
}
```

**Output:**
```typescript
{
  score: number, // 0-100
  reason: string,
  autoAction: 'approve' | 'reject' | 'manual'
}
```

### LLM Provider

**–û–ø—Ü–∏–∏:**
- OpenAI GPT-4 (recommended)
- Anthropic Claude
- OpenAI GPT-3.5 (fallback, –¥–µ—à–µ–≤–ª–µ)

**Cost optimization:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å GPT-3.5 –¥–ª—è –Ω–∏–∑–∫–æ–≥–æ —Ä–∏—Å–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
- GPT-4 –¥–ª—è —Å–ø–æ—Ä–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤

## Moderation Queue

**–§–∏–ª—å—Ç—Ä—ã:**
- Status: pending / auto_approved / auto_rejected
- AI Score: –¥–∏–∞–ø–∞–∑–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, 30-70)
- –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
- –ö–∞—Ç–µ–≥–æ—Ä–∏—è

**UI:**
- –°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π —Å AI score
- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è: Approve / Reject
- –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏—è

## Automatic Actions

**Auto-approve (score < 30):**
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `moderation_status = 'auto_approved'`
2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `status = 'active'`
3. –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤ `moderation_logs`
4. –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**Auto-reject (score > 70):**
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `moderation_status = 'auto_rejected'`
2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `status = 'blocked'`
3. –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤ `moderation_logs`
4. –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º

**Manual review (score 30-70):**
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `moderation_status = 'pending'`
2. –î–æ–±–∞–≤–∏—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º
3. –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ –ø—Ä–æ–≤–µ—Ä–∫–µ

## –ß–µ–∫-–ª–∏—Å—Ç MVP

- [ ] AI –º–æ–¥–µ—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ Edge Function (OpenAI/Anthropic API)
- [ ] Scoring —Å–∏—Å—Ç–µ–º–∞ (0-100)
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è (auto-approve/reject)
- [ ] –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—Å–∫–∞—è –æ—á–µ—Ä–µ–¥—å —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Ä–µ—à–µ–Ω–∏–π
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: –æ–¥–æ–±—Ä–µ–Ω–æ/–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ

## TODO for developers

1. **–°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏**
   - [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –≤ `adverts`: ai_moderation_score, ai_moderation_reason, moderation_status
   - [ ] –¢–∞–±–ª–∏—Ü–∞ `moderation_logs`
   - [ ] –ò–Ω–¥–µ–∫—Å—ã

2. **–°–æ–∑–¥–∞—Ç—å Edge Function ai-moderation**
   - [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenAI API
   - [ ] LLM prompt –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
   - [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –∏ –≤–æ–∑–≤—Ä–∞—Ç score
   - [ ] Error handling

3. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å API endpoint `/api/moderation/analyze`**
   - [ ] –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏—è
   - [ ] –í—ã–∑–æ–≤ Edge Function
   - [ ] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ score –≤ –ë–î
   - [ ] –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è

4. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å API endpoint `/api/moderation/review`**
   - [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∞
   - [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ moderation_status
   - [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è
   - [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

5. **–°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä—Å–∫—É—é –æ—á–µ—Ä–µ–¥—å**
   - [ ] API endpoint `/api/moderation/queue` —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
   - [ ] UI —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å —Å–ø–∏—Å–∫–æ–º –æ–±—ä—è–≤–ª–µ–Ω–∏–π
   - [ ] –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è Approve/Reject
   - [ ] –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä

6. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è**
   - [ ] Auto-approve –ª–æ–≥–∏–∫–∞
   - [ ] Auto-reject –ª–æ–≥–∏–∫–∞
   - [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
   - [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

7. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π**
   - [ ] Email –ø—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏
   - [ ] Email –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ (—Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º)
   - [ ] In-app —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

8. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏**
   - [ ] –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ç–æ—á–Ω–æ—Å—Ç–∏ AI (false positives/negatives)
   - [ ] –†–µ–≥—É–ª—è—Ä–Ω—ã–π review thresholds
   - [ ] A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö prompts

---

## üîó Related Docs

**Development:** [MASTER_CHECKLIST.md](./MASTER_CHECKLIST.md) ‚Ä¢ [admin-panel.md](./admin-panel.md) ‚Ä¢ [database-schema.md](./database-schema.md) ‚Ä¢ [backend-logic.md](./backend-logic.md)
**Catalog:** [CATALOG_MASTER.md](../catalog/CATALOG_MASTER.md)




