last_sync: 2025-10-28

# Chat & Conversations Domain

## Overview
- Realtime –¥–∏–∞–ª–æ–≥–∏ –ø—Ä–æ–¥–∞–≤–µ—Ü‚Üî–ø–æ–∫—É–ø–∞—Ç–µ–ª—å –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞ Supabase Realtime (websocket `postgres_changes`).
- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏: SSR –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, –ø–æ–¥–ø–∏—Å–∫–∞ –∂–∏–≤—ë—Ç —Ç–æ–ª—å–∫–æ –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ (`use client`).
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏: –ø—Ä–æ—Ñ–∏–ª–∏, –æ–±—ä—è–≤–ª–µ–Ω–∏—è (–∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–¥–µ–ª–∫–∏), –º–æ–¥–µ—Ä–∞—Ü–∏—è/–∂–∞–ª–æ–±—ã, –ª–æ–≥–∏, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.
- –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã: [domains/profile.md](./profile.md), [domains/adverts.md](./adverts.md), [domains/moderation.md](./moderation.md), [requirements.md](../requirements.md), [API_REFERENCE.md](../API_REFERENCE.md), [PLAN.md](../PLAN.md).

## Data Model (proposed)
- `public.conversations`:
  - `id uuid primary key default gen_random_uuid()`
  - `created_by uuid not null` ‚Üí `public.profiles.id`
  - `advert_id uuid null` ‚Üí `public.adverts.id` (–µ—Å–ª–∏ —á–∞—Ç –ø–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—é)
  - `last_message_at timestamptz`, `created_at timestamptz default now()`, `updated_at timestamptz`
- `public.conversation_participants`:
  - `conversation_id uuid` ‚Üí `public.conversations.id`
  - `user_id uuid` ‚Üí `public.profiles.id`
  - `role text` (`owner`, `peer`), `muted boolean default false`, `last_read_at timestamptz`
  - PK (`conversation_id`, `user_id`)
- `public.messages`:
  - `id bigint generated by default as identity primary key`
  - `conversation_id uuid not null` ‚Üí `public.conversations.id`
  - `author_id uuid not null` ‚Üí `public.profiles.id`
  - `body text not null`
  - `created_at timestamptz default now()`, `updated_at timestamptz`
  - –ò–Ω–¥–µ–∫—Å—ã: (`conversation_id`, `created_at`), (`author_id`, `created_at`)
- –¢—Ä–∏–≥–≥–µ—Ä `set_updated_at()` –¥–ª—è `conversations`/`messages`.
- –°–≤—è–∑–∏ —Å –º–æ–¥–µ—Ä–∞—Ü–∏–µ–π: —Å–æ–æ–±—â–µ–Ω–∏—è –º–æ–∂–Ω–æ –ø–æ–º–µ—á–∞—Ç—å –∂–∞–ª–æ–±–∞–º–∏ (—Å–º. –Ω–∏–∂–µ).

## RLS & Security
- `public.conversations`:
  - Select/Update: —É—á–∞—Å—Ç–Ω–∏–∫–∏ (`exists` –≤ `conversation_participants` –ø–æ `auth.uid()`) –∏–ª–∏ –∞–¥–º–∏–Ω—ã (`public.is_admin()`).
  - Insert: –ª—é–±–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å; –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–∞ 1:1-–¥–∏–∞–ª–æ–≥–∞.
- `public.conversation_participants`:
  - Select: —É—á–∞—Å—Ç–Ω–∏–∫–∏/–∞–¥–º–∏–Ω—ã.
  - Insert/Delete: —Ç–æ–ª—å–∫–æ —Å–µ—Ä–≤–∏—Å/—Å–æ–∑–¥–∞—Ç–µ–ª—å —á–µ—Ä–µ–∑ server action (–∑–∞–ø—Ä–µ—â–∞–µ–º —Å–∞–º–æ–≤–æ–ª—å–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞).
- `public.messages`:
  - Select: —É—á–∞—Å—Ç–Ω–∏–∫–∏ –¥–∏–∞–ª–æ–≥–∞.
  - Insert: `author_id = auth.uid()` –∏ —É—á–∞—Å—Ç–Ω–∏–∫ –¥–∏–∞–ª–æ–≥–∞.
  - Update/Delete: –∞–≤—Ç–æ—Ä –≤ –Ω–µ–±–æ–ª—å—à–æ–µ –æ–∫–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ –∏–ª–∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ).
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ `public.logs` (–¥–µ–π—Å—Ç–≤–∏—è `chat_send`, `chat_read`, `chat_mute`).

## API Surface (server actions / REST)
- `POST /api/chat/start` ‚Äî —Å–æ–∑–¥–∞—Ç—å/–Ω–∞–π—Ç–∏ –¥–∏–∞–ª–æ–≥ (–ø–æ `advert_id` –∏ `peer_id`).
- `POST /api/chat/send` ‚Äî –≤—Å—Ç–∞–≤–∫–∞ –≤ `messages` c –ø—Ä–æ–≤–µ—Ä–∫–æ–π —É—á–∞—Å—Ç–∏—è; –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–≥–æ UI.
- `POST /api/chat/read` ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å `participants.last_read_at`.
- `GET /api/chat/history?conversationId=...&cursor=...` ‚Äî –ø–∞–≥–∏–Ω–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π, SSR –¥–ª—è —Å—Ç–∞—Ä—Ç–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏.
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã: –ª–∏–º–∏—Ç –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, 20/–º–∏–Ω/–ø–æ–ª—å–∑.) –∏ —Å—É—Ç–æ—á–Ω–∞—è –∫–≤–æ—Ç–∞ –ø–æ IP.
- –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `supabaseService()` —Ç–æ–ª—å–∫–æ –ü–û–°–õ–ï –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ –¥–∏–∞–ª–æ–≥—É.

## Realtime Subscriptions
- –ö–∞–Ω–∞–ª: `conversation:${conversation_id}` —Å `postgres_changes` –Ω–∞ `public.messages` (INSERT/UPDATE –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏).
- –ö–ª–∏–µ–Ω—Ç: `use client` –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (`ChatWindow.tsx`) –∏–ª–∏ —Ö—É–∫ `useRealtimeMessages`:
  - `subscribe()` –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏, `unsubscribe()` –ø—Ä–∏ –∞–Ω–º–∞—É–Ω—Ç–µ.
  - –û–±—Ä–∞–±–æ—Ç–∫–∞ `system` —Å–æ–±—ã—Ç–∏–π/–æ—à–∏–±–æ–∫, –∞–≤—Ç–æ‚Äëreconnect (—ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞).
  - –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø–æ—Å–ª–µ–¥—É—é—â–µ–π —Å–≤–µ—Ä–∫–æ–π `id/created_at` –∏–∑ payload.
- SSR: –ø–æ–ª—É—á–∞—Ç—å —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ N —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ `supabaseServer()` –∏ –∫—É–∫–∏.

## Notifications & Delivery
- –°–æ–±—ã—Ç–∏—è: –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–∞/–≤—Å—Ç—Ä–µ—á–∏ (–ø—Ä–∏ —Å–≤—è–∑–∫–µ —Å deals), –º–∞—Å—Å–æ–≤—ã–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞.
- –ö–∞–Ω–∞–ª—ã –¥–æ—Å—Ç–∞–≤–∫–∏: email; push (OneSignal/Firebase) ‚Äî –∫–æ–Ω—Ñ–∏–≥ –≤ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ.
- –ü–æ–ª–∏—Ç–∏–∫–∞: –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å–∞–º–æ–º—É –∞–≤—Ç–æ—Ä—É; –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ 60 —Å–µ–∫—É–Ω–¥; ‚Äúquiet hours‚Äù.
- –•—Ä–∞–Ω–µ–Ω–∏–µ: –ª–æ–≥ –æ—Ç–ø—Ä–∞–≤–æ–∫ –≤ `public.logs` —Å –∫–ª—é—á–∞–º–∏ `event`, `channel`, `status`.

## Retention & GDPR
- –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: —Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è 6 –º–µ—Å—è—Ü–µ–≤ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–¥–µ–ª–∫–∏ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è; —á–∞—Ç—ã –±–µ–∑ —Å–¥–µ–ª–∫–∏ ‚Äî 6 –º–µ—Å—è—Ü–µ–≤ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.
- DSAR: —ç–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ –ø–æ `conversation_id`.
- –£–¥–∞–ª–µ–Ω–∏–µ: soft‚Äëdelete –∑–∞–ø–∏—Å–µ–π —Å –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –æ—á–∏—Å—Ç–∫–æ–π –∫—Ä–æ–Ω–æ–º (Edge Function) –∏ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–æ–π –∏–Ω–¥–µ–∫—Å–æ–≤.

## Moderation & Abuse
- –ñ–∞–ª–æ–±—ã –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: —Å–≤—è–∑—ã–≤–∞–µ–º —Å `public.reports` —á–µ—Ä–µ–∑ `target_type='message'`, `target_id=messages.id`.
- –ê–≤—Ç–æ‚Äëmute: –ø—Ä–∏ X –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã—Ö –∂–∞–ª–æ–±–∞—Ö –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫—É –≤ —Ä–∞–º–∫–∞—Ö N –¥–Ω–µ–π ‚Äî –ø–æ–º–µ—Ç–∫–∞ `muted=true` –≤ `participants`.
- –í UI ‚Äî –∫–Ω–æ–ø–∫–∞ ‚Äú–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è‚Äù –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–∏, –ø–æ–ø–∞–¥–∞–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥—å –º–æ–¥–µ—Ä–∞—Ü–∏–∏.

## Improvements & TODO Links
- TODO.md:
  - Ship migrations –¥–ª—è `conversations`/`participants`/`messages` –∏ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–∏–ø—ã.
  - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å server actions –∏ –ª–∏–º–∏—Ç—ã –æ—Ç–ø—Ä–∞–≤–∫–∏.
  - –°–æ–±—Ä–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π UI —Å –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –ø–æ–¥–ø–∏—Å–∫–∏, –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∏ retry.
  - –î–æ–±–∞–≤–∏—Ç—å QA: smoke‚Äë—Ç–µ—Å—Ç realtime, —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–∞, Sentry‚Äë–∞–ª–µ—Ä—Ç—ã `channel/system`.
  - –ü—Ä–æ—Ä–∞–±–æ—Ç–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ —Ä–µ—Ç–µ–Ω—à–Ω –ø–æ–ª–∏—Ç–∏–∫–∏; —Å–≤—è–∑–∞—Ç—å —Å –º–æ–¥–µ—Ä–∞—Ü–∏–µ–π.
- PLAN.md: —Ä–∞–∑–¥–µ–ª ‚ÄúRealtime‚Äë—á–∞—Ç‚Äù –∏ Post‚ÄëMVP –±–ª–æ–∫ —Ñ–∏–∫—Å–∏—Ä—É—é—Ç –∑–∞–¥–∞—á–∏ –∏ –∫—Ä–∏—Ç–µ—Ä–∏–∏.

## Change Log
- 2025-10-28: Initial domain doc with schema, RLS, realtime, notifications, retention, moderation and TODO links.

---

## üîó Related Docs

**Domains:** [deals.md](./deals.md) ‚Ä¢ [moderation.md](./moderation.md)
**Development:** [chat-messages.md](../development/chat-messages.md) ‚Ä¢ [MASTER_CHECKLIST.md](../development/MASTER_CHECKLIST.md) ‚Ä¢ [database-schema.md](../development/database-schema.md)
